# ----------------------------------------------------------------------
# è‚¡å¸‚æˆ°æƒ…å®¤ - æ¥µé€Ÿç©©å®šç‰ˆ (ç§»é™¤ä¸ç©©å®šçš„åœ‹ç™¼æœƒé€£ç·š)
# ----------------------------------------------------------------------

import streamlit as st
import plotly.express as px
import plotly.graph_objects as go
import yfinance as yf
import pandas as pd
import numpy as np
import concurrent.futures
from datetime import datetime

# --- 1. Streamlit é é¢è¨­å®š ---
st.set_page_config(
    page_title="è‚¡å¸‚å…¨æ–¹ä½æˆ°æƒ…å®¤", 
    layout="wide",
    initial_sidebar_state="expanded"
)

st.markdown("""
<style>
    .block-container { padding-top: 1rem; padding-bottom: 2rem; }
    h3 { margin-top: 2rem; border-bottom: 2px solid #f0f2f6; padding-bottom: 0.5rem; font-family: 'Arial Black', sans-serif; }
</style>
""", unsafe_allow_html=True)

# --- 2. å´é‚Šæ¬„æ§åˆ¶ ---
st.sidebar.header("âš™ï¸ æˆ°æƒ…æ§åˆ¶å°")
market_mode = st.sidebar.radio(
    "ğŸ“Š é¸æ“‡å„€è¡¨æ¿",
    [
        "ğŸ‡ºğŸ‡¸ ç¾è‚¡ S&P 500", 
        "ğŸ‡¹ğŸ‡¼ å°è‚¡æ¬Šå€¼è‚¡ (TWSE)", 
        "ğŸ“‰ ç¸½ç¶“èˆ‡é¢¨éšªæŒ‡æ¨™ (Macro)"
    ]
)

if st.sidebar.button('ğŸ”„ å¼·åˆ¶æ›´æ–°æ•¸æ“š', type="primary"):
    st.cache_data.clear()
    st.session_state.pop('last_update', None)
    st.rerun()

if 'last_update' in st.session_state:
    st.sidebar.caption(f"è³‡æ–™æ™‚é–“: {st.session_state['last_update']}")

st.title(f"ğŸ“Š {market_mode}")

# --- 3. æ ¸å¿ƒæ•¸æ“šå‡½æ•¸ (è‚¡ç¥¨) ---

@st.cache_data(ttl=24 * 3600)
def get_tw_constituents():
    data = [
        {'Ticker': '2330.TW', 'Name': 'å°ç©é›»', 'Sector': 'åŠå°é«”', 'Industry': 'æ™¶åœ“ä»£å·¥'},
        {'Ticker': '2454.TW', 'Name': 'è¯ç™¼ç§‘', 'Sector': 'åŠå°é«”', 'Industry': 'ICè¨­è¨ˆ'},
        {'Ticker': '3711.TW', 'Name': 'æ—¥æœˆå…‰', 'Sector': 'åŠå°é«”', 'Industry': 'å°æ¸¬'},
        {'Ticker': '2317.TW', 'Name': 'é´»æµ·', 'Sector': 'é›»å­ä»£å·¥', 'Industry': 'EMS'},
        {'Ticker': '2382.TW', 'Name': 'å»£é”', 'Sector': 'é›»å­ä»£å·¥', 'Industry': 'AIä¼ºæœå™¨'},
        {'Ticker': '3231.TW', 'Name': 'ç·¯å‰µ', 'Sector': 'é›»å­ä»£å·¥', 'Industry': 'AIä¼ºæœå™¨'},
        {'Ticker': '2357.TW', 'Name': 'è¯ç¢©', 'Sector': 'å“ç‰Œé›»è…¦', 'Industry': 'PC'},
        {'Ticker': '2376.TW', 'Name': 'æŠ€å˜‰', 'Sector': 'å“ç‰Œé›»è…¦', 'Industry': 'æ¿å¡'},
        {'Ticker': '2308.TW', 'Name': 'å°é”é›»', 'Sector': 'é›»å­é›¶çµ„ä»¶', 'Industry': 'é›»æº'},
        {'Ticker': '2881.TW', 'Name': 'å¯Œé‚¦é‡‘', 'Sector': 'é‡‘è', 'Industry': 'é‡‘æ§'},
        {'Ticker': '2882.TW', 'Name': 'åœ‹æ³°é‡‘', 'Sector': 'é‡‘è', 'Industry': 'é‡‘æ§'},
        {'Ticker': '2891.TW', 'Name': 'ä¸­ä¿¡é‡‘', 'Sector': 'é‡‘è', 'Industry': 'é‡‘æ§'},
        {'Ticker': '2886.TW', 'Name': 'å…†è±é‡‘', 'Sector': 'é‡‘è', 'Industry': 'é‡‘æ§'},
        {'Ticker': '1301.TW', 'Name': 'å°å¡‘', 'Sector': 'å‚³ç”¢', 'Industry': 'å¡‘è† '},
        {'Ticker': '2002.TW', 'Name': 'ä¸­é‹¼', 'Sector': 'å‚³ç”¢', 'Industry': 'é‹¼éµ'},
        {'Ticker': '2603.TW', 'Name': 'é•·æ¦®', 'Sector': 'èˆªé‹', 'Industry': 'è²¨æ«ƒ'},
        {'Ticker': '2609.TW', 'Name': 'é™½æ˜', 'Sector': 'èˆªé‹', 'Industry': 'è²¨æ«ƒ'},
        {'Ticker': '2618.TW', 'Name': 'é•·æ¦®èˆª', 'Sector': 'èˆªé‹', 'Industry': 'èˆªç©º'},
        {'Ticker': '2610.TW', 'Name': 'è¯èˆª', 'Sector': 'èˆªé‹', 'Industry': 'èˆªç©º'},
        {'Ticker': '2412.TW', 'Name': 'ä¸­è¯é›»', 'Sector': 'é€šä¿¡', 'Industry': 'é›»ä¿¡'}
    ]
    return pd.DataFrame(data)

@st.cache_data(ttl=24 * 3600)
def get_sp500_constituents():
    url = "https://raw.githubusercontent.com/datasets/s-and-p-500-companies/master/data/constituents.csv"
    try:
        df = pd.read_csv(url)
        df = df.rename(columns={'Symbol': 'Ticker', 'GICS Sector': 'Sector'})
        df['Ticker'] = df['Ticker'].str.replace('.', '-', regex=False)
        if 'GICS Sub-Industry' in df.columns:
            df = df.rename(columns={'GICS Sub-Industry': 'Industry'})
        else:
            df['Industry'] = df['Sector']
        return df
    except Exception:
        return pd.DataFrame()

# ä½¿ç”¨å¤šåŸ·è¡Œç·’å¹³è¡ŒæŠ“å–å¸‚å€¼
def fetch_single_cap(ticker):
    try:
        info = yf.